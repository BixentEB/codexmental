<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Article Studio v2 â€” Codex Mental</title>
<style>
  :root{
    --bg:#0f1220; --bg2:#12162a; --ink:#e9efff; --muted:#a9b5d1;
    --accent:#86c7ff; --accent2:#b28cff; --line:#22315a;
    --ok:#4ad295; --warn:#ffbe55; --bad:#ff6b6b; --radius:14px;
    --mono:ui-monospace,Menlo,Consolas,"Liberation Mono",monospace;
    --sans:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);font-family:var(--sans);line-height:1.45}

  header.appbar{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.1) blur(8px);
    background:linear-gradient(90deg,rgba(134,199,255,.12),transparent 35%,transparent 65%,rgba(178,140,255,.10));
    border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;padding:10px 14px;flex-wrap:wrap}
  header .title{font-weight:700}
  header .spacer{flex:1}
  .btn{background:#121739;border:1px solid var(--line);color:var(--ink);padding:.45rem .7rem;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.good{background:rgba(74,210,149,.10);border-color:rgba(74,210,149,.5)}
  .btn.small{padding:.35rem .55rem;font-size:.9rem}

  /* Layout responsive + modes */
 /* Layout responsive + modes */
.wrap{
  display:grid; gap:14px; padding:14px; height:calc(100% - 58px);
  transition:grid-template-columns .25s ease;
}
body[data-layout="equal"]  .wrap{grid-template-columns:1fr 1fr}
body[data-layout="left"]   .wrap{grid-template-columns:minmax(560px,2fr) minmax(420px,1fr)}
body[data-layout="right"]  .wrap{grid-template-columns:minmax(420px,1fr) minmax(560px,2fr)}

.btn.toggle[aria-pressed="true"]{
  outline:2px solid var(--accent);
  background:rgba(134,199,255,.15);
}


  .panel{border:1px solid var(--line);border-radius:var(--radius);background:#0c1125;min-height:0;display:flex;flex-direction:column}
  .panel h2{font-size:1rem;margin:0;padding:10px 12px;border-bottom:1px solid var(--line);color:#cfe3ff}
  .panel .content{padding:12px;overflow:auto;min-height:0;flex:1}

  .insertbar,.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  .row{display:grid;grid-template-columns:170px 1fr;gap:10px;align-items:start;margin-bottom:10px}
  .row label{color:var(--muted)}
  input[type="text"],input[type="url"],textarea,select{width:100%;background:#0a0f22;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:.6rem .7rem;font:inherit}
  textarea{min-height:110px;resize:vertical}
  .hint{color:var(--muted);font-size:.9rem}
  .fieldset{border:1px dashed var(--line);border-radius:12px;padding:10px;margin:10px 0}
  .fieldset .legend{font-size:.95rem;color:#cfe3ff;margin-bottom:8px}
  .chapters .item,.images .item{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px;background:#0b1230}
  .item .head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .item .head .title{font-weight:600;color:#dbe7ff}
  .item .head .ghost{color:#a9b5d1;font-size:.9rem}
  .head .controls{margin-left:auto;display:flex;gap:6px}
  .id-inline{display:flex;gap:8px;align-items:center}
  .id-inline input{width:260px}
  .images .grid{display:grid;gap:8px}
  .images .item .grid{grid-template-columns:1fr 1fr 120px 90px auto}
  .checkbox{display:flex;align-items:center;gap:6px;color:var(--muted)}
  .counter{font-size:.85rem;color:var(--muted);text-align:right}
  .code{white-space:pre;font-family:var(--mono);font-size:.92rem;line-height:1.4;background:#050814;padding:12px;border-radius:10px;overflow:auto;min-height:100%;border:1px solid var(--line)}
  .status{display:flex;gap:10px;align-items:center;margin:0 12px 12px}
  .pill{padding:.2rem .55rem;border-radius:999px;border:1px solid var(--line);color:#a9b5d1;background:#0b1130;font-size:.85rem}
</style>
</head>
<body data-layout="equal">
<header class="appbar">
  <div class="title">ðŸ§° Article Studio</div>
  <div class="spacer"></div>

  <!-- Layout controls -->
  <button id="btn-layout-left"  class="btn small toggle" title="Focus Ã‰dition (Ctrl+Alt+â†)">â‡¤ Ã‰dition</button>
  <button id="btn-layout-eq"    class="btn small toggle" title="50/50 (Ctrl+Alt+0)">50/50</button>
  <button id="btn-layout-right" class="btn small toggle" title="Focus AperÃ§u (Ctrl+Alt+â†’)">AperÃ§u â‡¥</button>

  <!-- Data controls -->
  <button id="btn-save" class="btn">Sauver</button>
  <button id="btn-load" class="btn">Charger</button>
  <button id="btn-export" class="btn">Export JSON</button>
  <input id="file-import" type="file" accept="application/json" hidden>
  <button id="btn-import" class="btn">Import JSON</button>
  <button id="btn-build" class="btn good">Valider / Construire</button>
  <button id="btn-download" class="btn">TÃ©lÃ©charger .html</button>
</header>

<div class="wrap">
  <section class="panel">
    <h2>Ã‰dition assistÃ©e</h2>
    <div class="content">
      <div class="insertbar">
        <button class="btn small" data-insert="title">+ Titre</button>
        <button class="btn small" data-insert="intro">+ Intro</button>
        <button class="btn small" data-insert="toc">+ Sommaire auto</button>
        <button class="btn small" data-insert="chapter">+ Chapitre</button>
        <button class="btn small" data-insert="media">+ MÃ©dias</button>
        <button class="btn small" data-insert="extras">+ Extras</button>
        <button class="btn small" data-insert="refs">+ RÃ©fÃ©rences</button>
        <button class="btn small" data-insert="caps">+ Capsules</button>
      </div>

      <div class="toolbar" id="formatbar">
        <span class="hint">Mise en forme (zone texte active) :</span>
        <button class="btn small" data-format="em"><i>I</i></button>
        <button class="btn small" data-format="strong"><b>B</b></button>
        <button class="btn small" data-format="u"><u>U</u></button>
        <button class="btn small" data-format="code"><span style="font-family:var(--mono)">code</span></button>
        <button class="btn small" data-format="link">Lien</button>
        <button class="btn small" data-format="ul">â€¢ Liste</button>
        <button class="btn small" data-format="ol">1. Liste</button>
        <button class="btn small" data-format="quote">Â« Citation Â»</button>
        <span class="hint">Raccourcis : Ctrl+B / Ctrl+I / Ctrl+U, Ctrl+K (lien)</span>
      </div>

      <!-- Title -->
      <div id="block-title" class="fieldset" hidden>
        <div class="legend">Titre (H1) + Sous-titre (optionnel)</div>
        <div class="row">
          <label for="inp-title">Titre</label>
          <input id="inp-title" type="text" placeholder="Mon titre">
        </div>
        <div class="row">
          <label for="inp-subtitle">Sous-titre</label>
          <input id="inp-subtitle" type="text" placeholder="Sous-titre (optionnel)">
        </div>
        <div class="row">
          <label>Mode sous-titre</label>
          <div>
            <label class="checkbox"><input type="radio" name="subtitleMode" value="data" checked> data-subtitle sur le H1</label>
            <label class="checkbox"><input type="radio" name="subtitleMode" value="p"> &lt;p class="subtitle"&gt;</label>
          </div>
        </div>
      </div>

      <!-- Intro -->
      <div id="block-intro" class="fieldset" hidden>
        <div class="legend">Introduction (H2 optionnel + contenu)</div>
        <div class="row">
          <label>Inclure lâ€™intro</label>
          <label class="checkbox"><input type="checkbox" id="chk-intro"> Ajouter une introduction</label>
        </div>
        <div class="row">
          <label for="inp-intro-title">Titre de lâ€™intro</label>
          <input id="inp-intro-title" type="text" placeholder="Introduction">
        </div>
        <textarea id="ta-intro" placeholder="â€¦ intro â€¦"></textarea>
        <div class="counter" data-for="ta-intro"></div>
      </div>

      <!-- TOC -->
      <div id="block-toc" class="fieldset" hidden>
        <div class="legend">Sommaire automatique</div>
        <label class="checkbox"><input type="checkbox" id="chk-toc" checked> GÃ©nÃ©rer une carte Â« Sommaire Â»</label>
      </div>

      <!-- Chapters -->
      <div id="block-chapters" class="fieldset" hidden>
        <div class="legend">Chapitres (H2 simples)</div>
        <div class="chapters" id="chapters"></div>
        <button class="btn small" id="btn-add-chapter">+ Ajouter un chapitre</button>
      </div>

      <!-- Media -->
      <div id="block-media" class="fieldset" hidden>
        <div class="legend">MÃ©dias (figure)</div>
        <div class="images" id="images"></div>
        <div class="row">
          <label>Figcaption</label>
          <input id="inp-caption" type="text" placeholder="Quelques images liÃ©es Ã  lâ€™article.">
        </div>
        <button class="btn small" id="btn-add-image">+ Ajouter une image</button>
        <div class="hint">Astuce : coche une image Â« principale Â» (data-main). Ordre rÃ©ordonnable avec â†‘â†“.</div>
      </div>

      <!-- Extras / References / Capsules -->
      <div id="block-extras" class="fieldset" hidden>
        <div class="legend">Extras</div>
        <textarea id="ta-extras" placeholder="â€¦"></textarea>
        <div class="counter" data-for="ta-extras"></div>
      </div>
      <div id="block-refs" class="fieldset" hidden>
        <div class="legend">RÃ©fÃ©rences</div>
        <textarea id="ta-refs" placeholder="â€¦"></textarea>
        <div class="counter" data-for="ta-refs"></div>
      </div>
      <div id="block-caps" class="fieldset" hidden>
        <div class="legend">Capsules</div>
        <textarea id="ta-caps" placeholder="â€¦"></textarea>
        <div class="counter" data-for="ta-caps"></div>
      </div>

      <div class="status">
        <div id="pill-save" class="pill">autosave 3 min â€¢ Ctrl+S</div>
        <div id="pill-dirty" class="pill">brouillon non sauvegardÃ©</div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>HTML final (copier / coller)</h2>
    <div class="content">
      <pre id="out" class="code">&lt;!-- RÃ©sultatâ€¦ --&gt;</pre>
    </div>
  </section>
</div>

<script>
/* ===== State & persistence ===== */
const KEY='cm-article-studio-v2a';
const KEY_UI='cm-article-studio-layout';
const state={
  title:'',subtitle:'',subtitleMode:'data',
  introEnabled:false,introTitle:'',intro:'',
  toc:true,
  chapters:[], // {n,id,title,html}
  media:{images:[],caption:''}, // {src,alt,main}
  extras:'',references:'',capsules:'',
  updatedAt:Date.now(),dirty:false,
  layout: localStorage.getItem(KEY_UI) || 'equal'
};
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const debounce=(fn,ms=600)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
function slugify(str){return (str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||'section'}
function markDirty(){state.dirty=true; $('#pill-dirty').textContent='modifications non sauvegardÃ©es'}
function saveLocal(){state.updatedAt=Date.now(); localStorage.setItem(KEY,JSON.stringify(state)); state.dirty=false; $('#pill-dirty').textContent='tout est sauvegardÃ©'}
function loadLocal(){const raw=localStorage.getItem(KEY); if(!raw) return; Object.assign(state,JSON.parse(raw)); renderAllFromState()}
function exportJSON(){const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='article-studio.json'; a.click(); URL.revokeObjectURL(a.href)}
function importJSON(file){const fr=new FileReader(); fr.onload=()=>{try{Object.assign(state,JSON.parse(fr.result)); renderAllFromState(); saveLocal()}catch{alert('Fichier JSON invalide')}}; fr.readAsText(file)}

/* ===== UI refs ===== */
const out=$('#out');
const insertButtons=$$('.insertbar .btn');
const btnSave=$('#btn-save'),btnLoad=$('#btn-load'),btnExport=$('#btn-export'),btnImport=$('#btn-import'),fileImport=$('#file-import');
const btnBuild=$('#btn-build'),btnDownload=$('#btn-download');
const btnLayoutLeft=$('#btn-layout-left'), btnLayoutEq=$('#btn-layout-eq'), btnLayoutRight=$('#btn-layout-right');
const blkTitle=$('#block-title'), inpTitle=$('#inp-title'), inpSubtitle=$('#inp-subtitle'), subtitleRadios=$$('input[name="subtitleMode"]');
const blkIntro=$('#block-intro'), chkIntro=$('#chk-intro'), inpIntroTitle=$('#inp-intro-title'), taIntro=$('#ta-intro');
const blkToc=$('#block-toc'), chkToc=$('#chk-toc');
const blkChapters=$('#block-chapters'), chaptersEl=$('#chapters'), btnAddChapter=$('#btn-add-chapter');
const blkMedia=$('#block-media'), imagesEl=$('#images'), btnAddImage=$('#btn-add-image'), inpCaption=$('#inp-caption');
const taExtras=$('#ta-extras'), taRefs=$('#ta-refs'), taCaps=$('#ta-caps');

/* ===== Layout handling ===== */
function setLayout(mode){
  if(!['left','equal','right'].includes(mode)) mode='equal';
  state.layout=mode;
  document.body.setAttribute('data-layout', mode);
  localStorage.setItem(KEY_UI, mode);

  // bouton actif
  [btnLayoutLeft, btnLayoutEq, btnLayoutRight].forEach(b=>b?.setAttribute('aria-pressed','false'));
  ({left:btnLayoutLeft, equal:btnLayoutEq, right:btnLayoutRight}[mode])?.setAttribute('aria-pressed','true');
}
// listeners de clic + raccourcis clavier
btnLayoutLeft.addEventListener('click',  ()=>setLayout('left'));
btnLayoutEq.addEventListener('click',    ()=>setLayout('equal'));
btnLayoutRight.addEventListener('click', ()=>setLayout('right'));
document.addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if((e.ctrlKey||e.metaKey) && e.altKey){
    if(k==='arrowleft'){ e.preventDefault(); setLayout('left') }
    if(k==='0'){        e.preventDefault(); setLayout('equal') }
    if(k==='arrowright'){e.preventDefault(); setLayout('right') }
  }
});

/* ===== Insert palette ===== */
insertButtons.forEach(b=>{
  b.addEventListener('click',()=>{
    const t=b.dataset.insert;
    if(t==='title'){blkTitle.hidden=false;inpTitle.focus()}
    if(t==='intro'){blkIntro.hidden=false;taIntro.focus()}
    if(t==='toc'){blkToc.hidden=false}
    if(t==='chapter'){blkChapters.hidden=false;addChapter()}
    if(t==='media'){blkMedia.hidden=false}
    if(t==='extras'){ $('#block-extras').hidden=false; taExtras.focus()}
    if(t==='refs'){ $('#block-refs').hidden=false; taRefs.focus()}
    if(t==='caps'){ $('#block-caps').hidden=false; taCaps.focus()}
  });
});

/* ===== Inputs sync ===== */
[ inpTitle,inpSubtitle,taIntro,taExtras,taRefs,taCaps,inpCaption,inpIntroTitle ].forEach(el=>{
  el.addEventListener('input',debounce(()=>{
    state.title=inpTitle.value; state.subtitle=inpSubtitle.value;
    state.intro=taIntro.value; state.introTitle=inpIntroTitle.value;
    state.extras=taExtras.value; state.references=taRefs.value; state.capsules=taCaps.value;
    state.media.caption=inpCaption.value; markDirty();
  },400));
});
chkIntro.addEventListener('change',()=>{state.introEnabled=chkIntro.checked; markDirty()});
subtitleRadios.forEach(r=>r.addEventListener('change',()=>{state.subtitleMode=r.value==='p'?'p':'data'; markDirty()}));
chkToc.addEventListener('change',()=>{state.toc=chkToc.checked; markDirty()});

/* ===== Counters ===== */
function updateCounters(){
  $$('.counter').forEach(c=>{
    const id=c.getAttribute('data-for'); const el=document.getElementById(id);
    const len=(el?.value||'').length; const words=(el?.value||'').trim().split(/\s+/).filter(Boolean).length;
    c.textContent=`${words} mots â€¢ ${len} caractÃ¨res`;
  });
}

/* ===== Chapters (H2 simples) ===== */
function chapterItem(ch){
  const root=document.createElement('div'); root.className='item'; root.dataset.id=ch.id;
  root.innerHTML=`
    <div class="head">
      <div class="title">Chapitre ${ch.n} â€” <span class="ghost">${ch.title||'(sans titre)'}</span></div>
      <div class="controls">
        <button class="btn small" data-act="up">â†‘</button>
        <button class="btn small" data-act="down">â†“</button>
        <button class="btn small" data-act="dup">Dupliquer</button>
        <button class="btn small bad" data-act="del">Supprimer</button>
      </div>
    </div>
    <div class="row">
      <label>Titre H2</label>
      <input type="text" class="ch-title" placeholder="Titre du chapitre" value="${ch.title||''}">
    </div>
    <div class="row id-inline">
      <label>ID (ancre)</label>
      <input type="text" class="ch-id" value="${ch.id}">
      <button class="btn small" data-act="slug">Slug</button>
    </div>
    <textarea class="ch-html" placeholder="â€¦ contenu â€¦">${ch.html||''}</textarea>
    <div class="counter"></div>`;
  const elTitle=$('.ch-title',root), elId=$('.ch-id',root), elHtml=$('.ch-html',root), counter=$('.counter',root);
  const syncCounter=()=>{counter.textContent=`${(elHtml.value.trim().split(/\s+/).filter(Boolean).length)} mots`};
  elTitle.addEventListener('input',debounce(()=>{ch.title=elTitle.value; $('.ghost',root).textContent=ch.title||'(sans titre)'; markDirty()},400));
  elId.addEventListener('input',debounce(()=>{ch.id=elId.value||slugify(ch.title); markDirty()},400));
  elHtml.addEventListener('input',debounce(()=>{ch.html=elHtml.value; updateCounters(); syncCounter(); markDirty()},400));
  root.addEventListener('click',ev=>{
    const act=ev.target?.dataset?.act; if(!act) return;
    if(act==='slug'){ elId.value=slugify(elTitle.value||ch.id); ch.id=elId.value; markDirty() }
    if(act==='up'){ moveChapter(ch.n,-1) }
    if(act==='down'){ moveChapter(ch.n,+1) }
    if(act==='dup'){ duplicateChapter(ch.n) }
    if(act==='del'){ deleteChapter(ch.n) }
  });
  syncCounter(); return root;
}
function renumberChapters(){state.chapters.forEach((c,i)=>c.n=i+1)}
function renderChapters(){chaptersEl.innerHTML=''; state.chapters.forEach(ch=>{chaptersEl.appendChild(chapterItem(ch))})}
function addChapter(){const n=state.chapters.length+1; const ch={n,id:'section-'+n,title:'',html:''}; state.chapters.push(ch); renderChapters(); markDirty()}
function moveChapter(n,delta){const i=state.chapters.findIndex(c=>c.n===n); const j=i+delta; if(j<0||j>=state.chapters.length) return; const tmp=state.chapters[i]; state.chapters[i]=state.chapters[j]; state.chapters[j]=tmp; renumberChapters(); renderChapters(); markDirty()}
function duplicateChapter(n){const i=state.chapters.findIndex(c=>c.n===n); const s=state.chapters[i]; const d={n:s.n+1,id:s.id+'-copy',title:s.title+' (copie)',html:s.html}; state.chapters.splice(i+1,0,d); renumberChapters(); renderChapters(); markDirty()}
function deleteChapter(n){ if(!confirm('Supprimer ce chapitre ?')) return; state.chapters=state.chapters.filter(c=>c.n!==n); renumberChapters(); renderChapters(); markDirty() }
btnAddChapter.addEventListener('click',addChapter);

/* ===== Media ===== */
function imageItem(img,idx){
  const root=document.createElement('div'); root.className='item';
  root.innerHTML=`
    <div class="head">
      <div class="title">Image ${idx+1}</div>
      <div class="controls">
        <button class="btn small" data-act="up">â†‘</button>
        <button class="btn small" data-act="down">â†“</button>
        <button class="btn small bad" data-act="del">Supprimer</button>
      </div>
    </div>
    <div class="grid">
      <input type="url" class="im-src" placeholder="/img/..." value="${img.src||''}">
      <input type="text" class="im-alt" placeholder="Texte alternatif" value="${img.alt||''}">
      <label class="checkbox"><input type="checkbox" class="im-main" ${img.main?'checked':''}> data-main</label>
      <div class="hint">(${idx+1})</div><div></div>
    </div>`;
  const elSrc=$('.im-src',root), elAlt=$('.im-alt',root), elMain=$('.im-main',root);
  const sync=debounce(()=>{img.src=elSrc.value; img.alt=elAlt.value; img.main=elMain.checked; markDirty()},300);
  elSrc.addEventListener('input',sync); elAlt.addEventListener('input',sync); elMain.addEventListener('change',sync);
  root.addEventListener('click',ev=>{
    const act=ev.target?.dataset?.act; if(!act) return; const i=state.media.images.indexOf(img);
    if(act==='up'&&i>0){const t=state.media.images[i-1]; state.media.images[i-1]=img; state.media.images[i]=t; renderImages(); markDirty()}
    if(act==='down'&&i<state.media.images.length-1){const t=state.media.images[i+1]; state.media.images[i+1]=img; state.media.images[i]=t; renderImages(); markDirty()}
    if(act==='del'){state.media.images.splice(i,1); renderImages(); markDirty()}
  });
  return root;
}
function renderImages(){imagesEl.innerHTML=''; state.media.images.forEach((im,i)=>imagesEl.appendChild(imageItem(im,i)))}
btnAddImage.addEventListener('click',()=>{state.media.images.push({src:'',alt:'',main:false}); renderImages(); markDirty()});

/* ===== Formatting toolbar ===== */
let activeTextArea=null;
document.addEventListener('focusin',e=>{ if(e.target.tagName==='TEXTAREA') activeTextArea=e.target });
$('#formatbar').addEventListener('click',e=>{
  const cmd=e.target?.dataset?.format||e.target?.parentElement?.dataset?.format; if(!cmd||!activeTextArea) return;
  const el=activeTextArea;
  const W={em:['<em>','</em>'],strong:['<strong>','</strong>'],u:['<u>','</u>'],code:['<code>','</code>'],quote:['<blockquote>','</blockquote>'],ul:['\n<ul>\n<li>','</li>\n</ul>\n'],ol:['\n<ol>\n<li>','</li>\n</ol>\n']};
  if(cmd==='link'){const href=prompt('URL du lien :','https://'); if(href){wrap(el,`<a href="${href}">`,'</a>')} return}
  const [b,a]=W[cmd]||['','']; wrap(el,b,a);
});
function wrap(el,before,after){ el.focus(); const s=el.selectionStart,e=el.selectionEnd,txt=el.value; const sel=txt.slice(s,e); el.value=txt.slice(0,s)+before+sel+after+txt.slice(e); el.setSelectionRange(s+before.length,e+before.length); el.dispatchEvent(new Event('input')) }

/* ===== Build HTML (v2 minimal + intro option) ===== */
function escapeHtml(s=''){return s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}
function escapeAttr(s=''){return s.replace(/"/g,'&quot;')}
function indent(s,sp=2){const pad=' '.repeat(sp); return s.split('\n').map(l=>pad+l).join('\n')}

function buildHTML(){
  // ids uniques pour H2 (chapitres)
  const seen=new Set();
  state.chapters.forEach(ch=>{
    let base=slugify(ch.title||ch.id||'section'); let id=base,k=2; while(seen.has(id)){id=`${base}-${k++}`} ch.id=id; seen.add(id);
  });

  // H1 + sous-titre
  const h1 = state.subtitleMode==='data'
    ? `<h1${state.subtitle?` data-subtitle="${escapeAttr(state.subtitle)}"`:''}>${escapeHtml(state.title||'Mon titre')}</h1>`
    : `<h1>${escapeHtml(state.title||'Mon titre')}</h1>\n  ${state.subtitle?`<p class="subtitle">${escapeHtml(state.subtitle)}</p>`:''}`;

  // Intro (H2 optionnel)
  let introBlock='';
  if(state.introEnabled){
    const t=(state.introTitle||'Introduction').trim()||'Introduction';
    const id = slugify(t||'introduction') || 'introduction';
    const body = (state.intro||'').trim();
    introBlock = `  <h2 id="${id}">${escapeHtml(t)}</h2>\n${body?indent(body,2)+'\n':''}\n`;
  }

  // TOC
  let toc='';
  if(state.toc && state.chapters.length){
    const links=state.chapters.map(ch=>`      <a href="#${ch.id}">${escapeHtml(ch.title||ch.id)}</a>`).join(' â€¢\n');
    toc = `  <section data-chapter="sommaire" id="sommaire">
    <h2>Sommaire</h2>
    <nav class="article-toc">
${links}
    </nav>
  </section>\n\n`;
  }

  // Chapitres en H2 simples
  const chs = state.chapters.map(ch=>{
    const body = ch.html?.trim() ? ch.html.trim() : '<p>â€¦ contenu â€¦</p>';
    return `  <h2 id="${ch.id}">${escapeHtml(ch.title||('Chapitre '+ch.n))}</h2>
${indent(body,2)}`;
  }).join('\n\n');

  // Article (data-article minimal)
  const article =
`<article data-article>
  <section data-part="title" class="title-chip">
    ${h1}
  </section>

  <!-- Outils (vide : le viewer injecte un partage par dÃ©faut) -->
  <section data-part="tools"></section>

${introBlock}${toc}${chs}
</article>`;

  // MÃ©dias (seulement si non vides)
  let media='';
  if((state.media.images&&state.media.images.length) || (state.media.caption||'').trim()){
    const imgs=(state.media.images||[]).map(im=>{
      const main=im.main?' data-main':''; const alt=escapeAttr(im.alt||''); const src=escapeAttr(im.src||'');
      return `    <img src="${src}" alt="${alt}"${main}>`;
    }).join('\n');
    const cap=(state.media.caption||'').trim()?`\n    <figcaption>${escapeHtml(state.media.caption.trim())}</figcaption>`:'';
    media = `<section data-part="media">
  <figure>
${imgs}${cap}
  </figure>
</section>`;
  }

  // Extras / refs / caps (Ã©mis uniquement s'il y a du contenu)
  const extras = (state.extras||'').trim()? `<section data-part="extras">\n${indent(state.extras.trim(),2)}\n</section>`:'';
  const refs   = (state.references||'').trim()? `<section data-part="references">\n${indent(state.references.trim(),2)}\n</section>`:'';
  const caps   = (state.capsules||'').trim()? `<section data-part="capsules">\n${indent(state.capsules.trim(),2)}\n</section>`:'';

  const full =
`<!-- =========================================================
  ARTICLE Ã©crit par Vincero â€” Ã©ditÃ© sur la plateforme Article Studio v2 (Codex Mental)
  ========================================================= -->
${article}

${media}
${extras}
${refs}
${caps}
`;
  out.textContent=full; return full;
}

/* ===== Download ===== */
function downloadHTML(){
  const html=buildHTML();
  const blob=new Blob([html],{type:'text/html'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=(slugify(state.title||'article')||'article')+'.html'; a.click(); URL.revokeObjectURL(a.href);
}

/* ===== Render / boot ===== */
function renderAllFromState(){
  // afficher les blocs
  blkTitle.hidden=false; blkIntro.hidden=false; blkToc.hidden=false; blkChapters.hidden=false; blkMedia.hidden=false;
  $('#block-extras').hidden=false; $('#block-refs').hidden=false; $('#block-caps').hidden=false;

  inpTitle.value=state.title||''; inpSubtitle.value=state.subtitle||''; (state.subtitleMode==='p'?subtitleRadios[1]:subtitleRadios[0]).checked=true;

  chkIntro.checked=!!state.introEnabled;
  inpIntroTitle.value=state.introTitle||'';
  taIntro.value=state.intro||'';

  chkToc.checked=!!state.toc;
  renderChapters();

  imagesEl.innerHTML=''; state.media.images=state.media.images||[]; renderImages(); inpCaption.value=state.media.caption||'';

  taExtras.value=state.extras||''; taRefs.value=state.references||''; taCaps.value=state.capsules||'';

  // layout initial
  setLayout(state.layout||'equal');

  updateCounters(); buildHTML();
}

btnSave.addEventListener('click',saveLocal);
btnLoad.addEventListener('click',()=>{loadLocal(); alert('Brouillon chargÃ©.')} );
btnExport.addEventListener('click',exportJSON);
btnImport.addEventListener('click',()=>fileImport.click());
fileImport.addEventListener('change',e=>{if(e.target.files?.[0]) importJSON(e.target.files[0])});
btnBuild.addEventListener('click',buildHTML);
btnDownload.addEventListener('click',downloadHTML);

/* Raccourcis */
let activeTextArea=null;
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveLocal() }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='enter'){ e.preventDefault(); buildHTML() }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b' && activeTextArea){ e.preventDefault(); wrap(activeTextArea,'<strong>','</strong>') }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i' && activeTextArea){ e.preventDefault(); wrap(activeTextArea,'<em>','</em>') }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='u' && activeTextArea){ e.preventDefault(); wrap(activeTextArea,'<u>','</u>') }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k' && activeTextArea){ e.preventDefault(); const href=prompt('URL du lien :','https://'); if(href) wrap(activeTextArea,`<a href="${href}">`,'</a>') }
});
document.addEventListener('focusin',e=>{ if(e.target.tagName==='TEXTAREA') activeTextArea=e.target });

/* Autosave 3 min + on idle */
setInterval(()=>{ if(state.dirty) saveLocal() },180000);
document.addEventListener('input',debounce(()=>{ updateCounters(); if(state.dirty) saveLocal() },1200));
window.addEventListener('beforeunload',e=>{ if(state.dirty){ e.preventDefault(); e.returnValue='' } });

renderAllFromState();
</script>

</body>
</html>
