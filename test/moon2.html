<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SunCalc - Analyse Lunaire</title>
    <style>
    #moon-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

#moon-widget {
    width: 300px;
    height: 300px;
    background: rgba(15, 23, 42, 0.9);
    border-radius: 30px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-family: 'Arial', sans-serif;
    transition: all 0.3s ease;
}

#moon-widget:hover {
    transform: scale(1.03);
    box-shadow: 0 15px 60px rgba(0, 0, 0, 0.5);
}

/* Remplacer le style existant de #moon-phase */
#moon-phase {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: #f8f8f8;
    box-shadow: 
        inset 5px 5px 15px rgba(0, 0, 0, 0.2),
        0 0 40px rgba(255, 215, 0, 0.6);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
    /* Nouveau: masque pour les phases */
    mask: radial-gradient(circle at var(--mask-position, 50% 50%), 
          transparent var(--mask-size, 0%), 
          #000 0);
    -webkit-mask: radial-gradient(circle at var(--mask-position, 50% 50%), 
          transparent var(--mask-size, 0%), 
          #000 0);
}

#moon-phase::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #0f172a;
    border-radius: 50%;
    transform: scale(1);
    transform-origin: right center;
    transition: transform 0.5s ease;
}

#moon-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 18px;
    text-align: center;
    margin-bottom: 10px;
}

#moon-percent {
    font-weight: bold;
    font-size: 24px;
    margin-bottom: 5px;
}

#moon-name {
    opacity: 0.8;
    font-size: 16px;
}

#moon-location {
    display: flex;
    align-items: center;
    margin-top: 15px;
    font-size: 14px;
    opacity: 0.8;
}

#moon-location-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 14px;
    margin-left: 8px;
    opacity: 0.8;
    transition: opacity 0.2s;
}

#moon-location-btn:hover {
    opacity: 1;
}

/* Animation pour la lune */
@keyframes moonGlow {
    0% { box-shadow: inset 10px 10px 20px rgba(0, 0, 0, 0.25), 0 0 40px rgba(255, 215, 0, 0.6); }
    100% { box-shadow: inset 10px 10px 20px rgba(0, 0, 0, 0.25), 0 0 60px rgba(255, 215, 0, 0.9); }
}
    </style>
</head>
<body>
    <h1>ðŸŒ™ Debug SunCalc - DonnÃ©es Lunaires Actuelles</h1>
    
<div id="moon-container">
    <div id="moon-widget">
        <div id="moon-phase"></div>
        <div id="moon-info">
            <span id="moon-percent"></span>
            <span id="moon-name"></span>
        </div>
        <div id="moon-location">
            <span id="moon-location-text"></span>
            <button id="moon-location-btn">ðŸ”„</button>
        </div>
    </div>
</div>

    <script>
    // Chargement de SunCalc depuis CDN
const script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/suncalc@1.8.0/suncalc.min.js';
script.onload = initMoonWidget;
document.head.appendChild(script);

// Configuration par dÃ©faut (Lyon, France)
const defaultLocation = {
    lat: 45.764043,
    lng: 4.835659
};

let currentLocation = {...defaultLocation};
let locationName = "Lyon, FR";

function initMoonWidget() {
    // VÃ©rifier si la gÃ©olocalisation est disponible
    if (navigator.geolocation) {
        getLocationName(defaultLocation.lat, defaultLocation.lng)
            .then(name => {
                locationName = name || "Lyon, FR";
                updateLocationText();
            });
        
        // Demander la position actuelle
        requestLocation();
    } else {
        updateLocationText();
    }
    
    // Mettre Ã  jour la lune immÃ©diatement
    updateMoon();
    
    // Mettre Ã  jour toutes les heures et Ã  minuit pour le changement de jour
    setInterval(updateMoon, 3600000); // 1 heure
    scheduleMidnightUpdate();
    
    // Bouton de rafraÃ®chissement de la localisation
    document.getElementById('moon-location-btn').addEventListener('click', requestLocation);
}

function requestLocation() {
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            getLocationName(currentLocation.lat, currentLocation.lng)
                .then(name => {
                    locationName = name || `Lat: ${currentLocation.lat.toFixed(2)}, Lng: ${currentLocation.lng.toFixed(2)}`;
                    updateLocationText();
                    updateMoon();
                });
        },
        (error) => {
            console.log("Geolocation error:", error);
            // Utiliser la position par dÃ©faut
            currentLocation = {...defaultLocation};
            updateLocationText();
        },
        { timeout: 5000 }
    );
}

async function getLocationName(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`);
        const data = await response.json();
        
        if (data.address) {
            if (data.address.city) {
                return `${data.address.city}, ${data.address.country_code.toUpperCase()}`;
            } else if (data.address.town) {
                return `${data.address.town}, ${data.address.country_code.toUpperCase()}`;
            } else if (data.address.village) {
                return `${data.address.village}, ${data.address.country_code.toUpperCase()}`;
            }
        }
        return null;
    } catch (error) {
        console.log("Geocoding error:", error);
        return null;
    }
}

function updateLocationText() {
    document.getElementById('moon-location-text').textContent = locationName;
}

function updateMoon() {
    const now = new Date();
    const moonData = SunCalc.getMoonIllumination(now);
    const phase = moonData.phase; // 0 Ã  1
    const fraction = moonData.fraction; // % illuminÃ© (0 Ã  1)
    const angle = moonData.angle; // angle de l'Ã©clairage
    
    // Mettre Ã  jour l'affichage de la lune
    updateMoonVisual(fraction, angle);
    
    // Mettre Ã  jour les infos textuelles
    updateMoonInfo(fraction, phase);
}

function updateMoonVisual(fraction, angle) {
    const moonElement = document.getElementById('moon-phase');
    const radianAngle = angle;
    
    // Calcul de la position du masque en fonction de l'angle
    const x = 50 + 50 * Math.cos(radianAngle);
    const y = 50 + 50 * Math.sin(radianAngle);
    
    // DÃ©terminer la taille du masque en fonction de la phase
    let maskSize;
    if (fraction <= 0.5) {
        // Phase croissante (0% Ã  50%)
        maskSize = 100 - (fraction * 200);
    } else {
        // Phase dÃ©croissante (50% Ã  100%)
        maskSize = (fraction - 0.5) * 200;
    }
    
    // Appliquer les propriÃ©tÃ©s CSS
    moonElement.style.setProperty('--mask-position', `${x}% ${y}%`);
    moonElement.style.setProperty('--mask-size', `${maskSize}%`);
    
    // Rotation pour orienter correctement la phase
    moonElement.style.transform = `rotate(${radianAngle + Math.PI/2}rad)`;
    
    // Animation de lueur
    moonElement.style.animation = 'moonGlow 3s infinite alternate';
}

function updateMoonInfo(fraction, phase) {
    const percentElement = document.getElementById('moon-percent');
    const nameElement = document.getElementById('moon-name');
    
    // Pourcentage arrondi
    const percent = Math.round(fraction * 100);
    percentElement.textContent = `${percent}%`;
    
    // Nom de la phase
    const phaseName = getMoonPhaseName(phase, fraction);
    nameElement.textContent = phaseName;
}

function getMoonPhaseName(phase, fraction) {
    if (phase < 0.03 || phase >= 0.97) return 'Nouvelle Lune';
    if (phase < 0.22) return fraction < 0.5 ? 'Premier Croissant' : 'Premier Quartier';
    if (phase < 0.28) return 'Lune Gibbeuse Croissante';
    if (phase < 0.47) return 'Pleine Lune';
    if (phase < 0.53) return 'Lune Gibbeuse DÃ©croissante';
    if (phase < 0.72) return fraction < 0.5 ? 'Dernier Quartier' : 'Dernier Croissant';
    if (phase < 0.78) return 'Lune Gibbeuse DÃ©croissante';
    return 'Lune Gibbeuse Croissante';
}

function scheduleMidnightUpdate() {
    const now = new Date();
    const midnight = new Date();
    midnight.setHours(24, 0, 0, 0);
    
    const timeToMidnight = midnight - now;
    
    setTimeout(() => {
        updateMoon();
        // Reschedule pour le prochain minuit
        scheduleMidnightUpdate();
    }, timeToMidnight);
}
    </script>
</body>
</html>
