<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Routine capillaire + Phases Kératine</title>
<link rel="icon" href="data:,"/>
<style>
:root{--bg:#0b0f14;--panel:#121821;--text:#e6edf3;--muted:#8aa0b3;--line:#223041;--tag:#1b2431}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a111a,#0b0f14 40%);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif}
.wrap{max-width:1100px;margin:auto;padding:24px}
h1{margin:0 0 10px;font-size:clamp(20px,3.6vw,28px)}
small.muted{color:var(--muted)}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
.tag{display:inline-block;background:var(--tag);border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:#cfe7ff;font-size:.8rem}
.pill{border:1px solid var(--line);background:#0f1722;padding:4px 10px;border-radius:999px}

/* Today */
.today{display:grid;gap:10px;margin:14px 0}
.today .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.today .cols{display:grid;gap:12px;grid-template-columns:1.2fr 1.2fr .9fr}
.today ul{margin:8px 0 0 18px}

/* Tabs */
.tabs{margin-top:14px}
.tab-head{display:flex;gap:8px;flex-wrap:wrap}
.tab-head button{background:var(--tag);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
.tab-head button[aria-selected="true"]{background:#1c2736}
.tab{display:none;margin-top:12px}
.tab.active{display:block}

/* Week grid */
.grid{display:grid;gap:12px;grid-template-columns:140px 1fr 1fr 1.1fr}
.head,.cell{background:var(--panel);border:1px solid var(--line)}
.head{padding:10px 12px;font-weight:700;text-transform:uppercase;background:linear-gradient(180deg,#131b25,#101722)}
.cell{padding:12px}
.note{color:var(--muted)}
.day{font-weight:700}
.subtag{margin-top:6px}
.todo{display:grid;gap:10px}
.todo label{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:baseline;background:rgba(255,255,255,.02);padding:8px;border:1px dashed var(--line);border-radius:10px}

/* Keratin */
.k-box{display:grid;gap:12px}
.k-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input[type="date"]{background:var(--tag);border:1px solid var(--line);color:var(--text);padding:8px;border-radius:10px}
.k-timeline{display:grid;gap:10px;margin-top:8px}
.k-phase{padding:10px;border:1px dashed var(--line);border-radius:10px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
button{background:var(--tag);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
button:hover{filter:brightness(1.07)}

@media(max-width:870px){
  .grid{grid-template-columns:1fr}.head{display:none}
  .today .cols{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>🌕 Routine capillaire + Phases Kératine</h1>
  <small class="muted">
    Shampoings <b>lundi & jeudi</b> • Huile d’oignon <b>la veille (mer & dim) et le jour même (pré-shampoing)</b> •
    Minoxidil matin/soir sur cuir chevelu <b>sec</b>. Les phases <b>kératine</b> sont des <u>dosages par périodes</u>.
  </small>

  <!-- Aujourd’hui -->
  <div class="panel today" id="todayCard">
    <div class="meta">
      <span class="pill">📅 <b id="todayDate">—</b></span>
      <span class="pill">🧭 <b id="todayJour">—</b></span>
      <span id="todayTag" class="tag">Routine</span>
      <span class="pill">💊 <span id="todayKeratin">—</span></span>
    </div>
    <div class="cols">
      <div><b>Matin</b><ul id="todayMatin"></ul></div>
      <div><b>Soir</b><ul id="todaySoir"></ul></div>
      <div><b>Mémo</b><div class="muted" id="todayNote">—</div></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-head">
      <button data-tab="week" aria-selected="true">🗓️ Semaine type</button>
      <button data-tab="attack">⚡ Kératine – Phase d’attaque</button>
      <button data-tab="maint">🌿 Kératine – Phase d’entretien</button>
    </div>

    <section id="week" class="tab active">
      <div class="grid" id="weekGrid" aria-live="polite"></div>
    </section>

    <section id="attack" class="tab">
      <div class="k-box">
        <div class="k-top">
          <span class="tag">Protocole d’attaque : 45 jours</span>
          <div>
            <label>Démarrer le :
              <input id="startAttack" type="date">
            </label>
            <span id="attackStatus" class="pill">Jour — Dosage —</span>
            <div class="actions">
              <button id="todayAttack">Aujourd’hui</button>
              <button id="activateAttack">Activer</button>
              <button id="resetAttack">Réinitialiser</button>
            </div>
          </div>
        </div>
        <div class="k-timeline">
          <div class="k-phase"><b>P1 J1–J15</b> 2 gél./jour</div>
          <div class="k-phase"><b>P2 J16–J45</b> 3 gél./jour</div>
        </div>
      </div>
    </section>

    <section id="maint" class="tab">
      <div class="k-box">
        <div class="k-top">
          <span class="tag">Protocole d’entretien : 75 jours</span>
          <div>
            <label>Démarrer le :
              <input id="startMaint" type="date">
            </label>
            <span id="maintStatus" class="pill">Jour — Dosage —</span>
            <div class="actions">
              <button id="todayMaint">Aujourd’hui</button>
              <button id="activateMaint">Activer</button>
              <button id="resetMaint">Réinitialiser</button>
            </div>
          </div>
        </div>
        <div class="k-timeline">
          <div class="k-phase"><b>P1 J1–J30</b> 1 gél./jour</div>
          <div class="k-phase"><b>P2 J31–J75</b> 2 gél./jour</div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ====== Helpers (définis AVANT tout usage) ====== */
  const DAY_NAMES = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
  const SHAMPOO_DAYS = [1,4]; // Lundi, Jeudi
  const OIL_DURATION = "2 h ou nuit (sous charlotte)";
  const fmt = d => d.toISOString().slice(0,10);
  const daysSince = start => {
    const s=new Date(start), t=new Date();
    s.setHours(0,0,0,0); t.setHours(0,0,0,0);
    return Math.floor((t-s)/86400000)+1;
  };
  const isVeille = (dayNum) => SHAMPOO_DAYS.some(sd => ((sd + 5) % 7) + 1 === dayNum);

  function buildDay(dayNum){
    const name = DAY_NAMES[dayNum-1];
    const shampooDay = SHAMPOO_DAYS.includes(dayNum);
    const veille = isVeille(dayNum);

    let matin = [
      "🧅 Jus d’oignon (1 h) → Rinçage → Séchage",
      "💧 Minoxidil 5 %"
    ];
    let soir = [
      "🧅 Jus d’oignon (1 h) → Rinçage → Séchage",
      "💧 Minoxidil 5 %"
    ];
    let tag = "";
    let note = "Routine classique — stimulation + hydratation interne.";

    if (veille){
      tag = "Veille soin huile";
      soir = [`💆‍♂️ Huile d’oignon ${OIL_DURATION}`];
      note = "Masse doucement le cuir chevelu pendant l’huile.";
    }
    if (shampooDay){
      tag = "Jour de shampoing";
      matin = [
        `💆‍♂️ Huile d’oignon ${OIL_DURATION} (pré-shampoing)`,
        "🧴 Shampoing doux → Séchage",
        "💧 Minoxidil 5 %"
      ];
      soir = ["💧 Minoxidil 5 %"];
      note = "Cuir chevelu propre, prêt à absorber les actifs. Laisse bien respirer.";
    }
    if (name==="Dimanche" && !shampooDay && !veille){
      note = "Récupération & visualisation de la repousse 🌱.";
    }
    return { j:name, tag, m:matin, s:soir, note };
  }

/* ========= KÉRATINE (fix) ========= */
const Keratin = {
  mode: localStorage.getItem("ker-mode") || "attack",
  startAttack: localStorage.getItem("ker-attack-start") || "",
  startMaint:  localStorage.getItem("ker-maint-start")  || "",

  setMode(m){
    this.mode = m;
    localStorage.setItem("ker-mode", m);
    refreshToday(); // met à jour la carte du jour
  },

  setStart(key, val){
    localStorage.setItem(key, val);
    if (key === "ker-attack-start") this.startAttack = val;
    if (key === "ker-maint-start")  this.startMaint  = val;
    refreshToday(); // recalcul dose du jour
  },

  doseFor(dateStr){
    const start = (this.mode === "attack") ? this.startAttack : this.startMaint;
    if (!start) return "— (définir la date de début)";

    const d0 = new Date(start), d = new Date(dateStr);
    d0.setHours(0,0,0,0); d.setHours(0,0,0,0);
    const j = Math.floor((d - d0)/86400000) + 1;

    if (this.mode === "attack") {
      if (j < 1)  return "— (pas commencé)";
      if (j <= 15) return "2 gél./jour (P1)";
      if (j <= 45) return "3 gél./jour (P2)";
      return "✓ Attaque terminée";
    } else {
      if (j < 1)  return "— (pas commencé)";
      if (j <= 30) return "1 gél./jour (P1)";
      if (j <= 75) return "2 gél./jour (P2)";
      return "✓ Entretien terminé";
    }
  }
};


  /* ====== Onglets ====== */
  document.querySelectorAll('.tab-head button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-head button').forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  /* ====== Semaine type : build + render ====== */
  function buildWeek(){
    return Array.from({length:7}, (_,i)=>buildDay(i+1));
  }

  function renderWeek(){
    const weekGrid = document.getElementById('weekGrid');
    if(!weekGrid){ console.error('weekGrid introuvable'); return; }

    // reset
    weekGrid.innerHTML = '';

    // headers
    ["Jour","Matin","Soir","Notes"].forEach(h=>{
      const d=document.createElement('div'); d.className='head'; d.textContent=h; weekGrid.appendChild(d);
    });

    // data
    const KEY="cap-week-v3";
    const saved=JSON.parse(localStorage.getItem(KEY)||"{}");
    const chk = (id, text) => {
      const L=document.createElement('label');
      const c=document.createElement('input'); c.type='checkbox'; c.checked=!!saved[id];
      c.addEventListener('change',()=>{ saved[id]=c.checked; localStorage.setItem(KEY,JSON.stringify(saved)); });
      const s=document.createElement('span'); s.textContent=text;
      L.appendChild(c); L.appendChild(s); return L;
    };

    const week = buildWeek();
    week.forEach((d,di)=>{
      const cDay=document.createElement('div'); cDay.className='cell';
      cDay.innerHTML=`<div class="day">${d.j}${d.tag?`<div class="tag subtag">${d.tag}</div>`:''}</div>`;
      const cM=document.createElement('div'); cM.className='cell';
      const tm=document.createElement('div'); tm.className='todo';
      d.m.forEach((t,ti)=>tm.appendChild(chk(`m-${di}-${ti}`,t))); cM.appendChild(tm);

      const cS=document.createElement('div'); cS.className='cell';
      const ts=document.createElement('div'); ts.className='todo';
      d.s.forEach((t,ti)=>ts.appendChild(chk(`s-${di}-${ti}`,t))); cS.appendChild(ts);

      const cN=document.createElement('div'); cN.className='cell';
      cN.innerHTML=`<div class="note">${d.note}</div>`;

      [cDay,cM,cS,cN].forEach(x=>weekGrid.appendChild(x));
    });
  }

  /* ====== Today card ====== */
  function todayData(){
    const now=new Date();
    const dow=((now.getDay()+6)%7)+1; // 1..7
    const d=buildDay(dow);
    return {
      date: fmt(now),
      jour: d.j,
      tag: d.tag || "Routine",
      matin: d.m,
      soir: d.s,
      note: d.note,
      keratin: Keratin.doseFor(fmt(now))
    };
  }
  function refreshToday(){
    const t=todayData();
    document.getElementById('todayDate').textContent=t.date;
    document.getElementById('todayJour').textContent=t.jour;
    document.getElementById('todayTag').textContent=t.tag;
    document.getElementById('todayKeratin').textContent=t.keratin;
    document.getElementById('todayMatin').innerHTML=t.matin.map(x=>`<li>${x}</li>`).join('');
    document.getElementById('todaySoir').innerHTML=t.soir.map(x=>`<li>${x}</li>`).join('');
    document.getElementById('todayNote').textContent=t.note;
  }

  /* ====== Keratin UI wiring ====== */
  const startAttack = document.getElementById('startAttack');
  const attackStatus = document.getElementById('attackStatus');
  const startMaint  = document.getElementById('startMaint');
  const maintStatus = document.getElementById('maintStatus');

  function updAttack(){
    if(!attackStatus) return;
    const v = startAttack.value;
    if(!v){ attackStatus.textContent="Jour — Dosage —"; Keratin.setStart("ker-attack-start",""); return; }
    const j=daysSince(v);
    attackStatus.textContent = j<1 ? "Jour — (pas commencé)" :
      j<=15 ? `Jour ${j} · 2 gél./jour (P1)` :
      j<=45 ? `Jour ${j} · 3 gél./jour (P2)` :
              `Jour ${j} · ✓ Attaque terminée`;
    Keratin.setStart("ker-attack-start", v);
  }
  function updMaint(){
    if(!maintStatus) return;
    const v = startMaint.value;
    if(!v){ maintStatus.textContent="Jour — Dosage —"; Keratin.setStart("ker-maint-start",""); return; }
    const j=daysSince(v);
    maintStatus.textContent = j<1 ? "Jour — (pas commencé)" :
      j<=30 ? `Jour ${j} · 1 gél./jour (P1)` :
      j<=75 ? `Jour ${j} · 2 gél./jour (P2)` :
              `Jour ${j} · ✓ Entretien terminé`;
    Keratin.setStart("ker-maint-start", v);
  }

  startAttack && (startAttack.value = Keratin.startAttack);
  startMaint  && (startMaint.value  = Keratin.startMaint);
  document.getElementById('todayAttack')?.addEventListener('click',()=>{ startAttack.value=fmt(new Date()); updAttack(); });
  document.getElementById('resetAttack')?.addEventListener('click',()=>{ startAttack.value=""; updAttack(); });
  document.getElementById('activateAttack')?.addEventListener('click',()=> Keratin.setMode("attack"));
  document.getElementById('todayMaint')?.addEventListener('click',()=>{ startMaint.value=fmt(new Date()); updMaint(); });
  document.getElementById('resetMaint')?.addEventListener('click',()=>{ startMaint.value=""; updMaint(); });
  document.getElementById('activateMaint')?.addEventListener('click',()=> Keratin.setMode("maint"));

  /* ====== RUN ====== */
  renderWeek();     // ← construit la Semaine type
  refreshToday();   // ← remplit la carte “Aujourd’hui”
  updAttack();      // ← met à jour le statut affiché
  updMaint();

});
</script>
</body>
</html>
