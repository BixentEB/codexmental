<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur de Phases Lunaires</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        .simul-widget {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .simul-title {
            color: #333;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .moon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .moon-phase {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #333;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        
        #simul-svg {
            width: 100%;
            height: 100%;
        }
        
        #simul-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            margin: 15px 0;
        }
        
        #simul-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
        }
        
        #simul-label {
            font-size: 1.2em;
            color: #4a6fa5;
            font-weight: bold;
            min-height: 1.5em;
        }
        
        #simul-reset {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        #simul-reset:hover {
            background-color: #3a5a80;
        }
        
        .moon-date {
            font-size: 1.1em;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .slider-marks {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
        }
        
        .slider-mark {
            width: 1px;
            height: 10px;
            background-color: #999;
        }
    </style>
</head>
<body>
    <div id="simul-moon-container"></div>

    <script>
        // simul-moon.js â€“ Simulateur lunaire avancÃ© avec phase rÃ©elle + simulation manuelle
        // Version amÃ©liorÃ©e avec meilleure reprÃ©sentation des phases et dates
        (() => {
            const wrapper = document.createElement("div");
            wrapper.className = "simul-widget";

            const container = document.createElement("div");
            container.id = "simul-moon";
            container.innerHTML = `
                <h3 class="simul-title">ðŸŒ™ Simulateur Lunaire</h3>
                <div class="moon-wrapper">
                    <svg id="simul-svg" viewBox="0 0 100 100" class="moon-phase">
                        <defs>
                            <clipPath id="simul-clip">
                                <circle cx="50" cy="50" r="50" />
                            </clipPath>
                            <mask id="simul-mask">
                                <rect width="100" height="100" fill="white" />
                                <path id="simul-shadow-path" fill="black" />
                            </mask>
                        </defs>
                        <circle cx="50" cy="50" r="50" fill="#fff" mask="url(#simul-mask)" clip-path="url(#simul-clip)" />
                    </svg>
                    <div class="moon-date" id="simul-date"></div>
                    <input type="range" id="simul-slider" min="0" max="1" step="0.01" value="0.5">
                    <div class="slider-marks">
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                        <div class="slider-mark"></div>
                    </div>
                    <div id="simul-label">Phase : ...</div>
                    <button id="simul-reset">â†º Phase actuelle</button>
                </div>
            `;

            wrapper.appendChild(container);
            document.getElementById("simul-moon-container")?.appendChild(wrapper);

            const slider = document.getElementById("simul-slider");
            const shadowPath = document.getElementById("simul-shadow-path");
            const label = document.getElementById("simul-label");
            const resetBtn = document.getElementById("simul-reset");
            const dateLabel = document.getElementById("simul-date");

            // Noms des phases lunaires avec meilleures transitions
            function getPhaseName(p) {
                if (p < 0.03 || p > 0.97) return "ðŸŒ‘ Nouvelle Lune";
                if (p < 0.22) return "ðŸŒ’ Premier Croissant";
                if (p < 0.28) return "ðŸŒ“ Premier Quartier";
                if (p < 0.47) return "ðŸŒ” Lune Gibbeuse Croissante";
                if (p <= 0.53) return "ðŸŒ• Pleine Lune";
                if (p < 0.72) return "ðŸŒ– Lune Gibbeuse DÃ©croissante";
                if (p < 0.78) return "ðŸŒ— Dernier Quartier";
                if (p <= 0.97) return "ðŸŒ˜ Dernier Croissant";
                return "ðŸŒ‘ Nouvelle Lune";
            }

            // Meilleure reprÃ©sentation visuelle des phases
            function updatePhasePath(phase) {
                if (!shadowPath) return;

                const cx = 50, cy = 50, r = 50;
                const isWaxing = phase < 0.5;
                const illum = Math.abs(0.5 - phase) * 2; // 0 (pleine) Ã  1 (nouvelle)

                // Cas limites
                if (illum < 0.01) {
                    shadowPath.setAttribute("d", "M 0,0 L 0,0"); // pleine lune
                    return;
                }
                if (illum > 0.99) {
                    shadowPath.setAttribute("d", "M 0,0 L 100,0 L 100,100 L 0,100 Z"); // nouvelle lune
                    return;
                }

                // Calcul plus prÃ©cis de la forme de l'ombre
                const ellipseW = r * (2 * (1 - illum));
                const controlOffset = r * 0.55 * (1 - illum);

                let path;
                if (isWaxing) {
                    // Ombre Ã  gauche (phase croissante)
                    path = `M ${cx},${cy - r}
                            A ${r},${r} 0 0,1 ${cx},${cy + r}
                            A ${ellipseW},${r} 0 0,0 ${cx},${cy - r} Z`;
                } else {
                    // Ombre Ã  droite (phase dÃ©croissante)
                    path = `M ${cx},${cy - r}
                            A ${ellipseW},${r} 0 0,1 ${cx},${cy + r}
                            A ${r},${r} 0 0,0 ${cx},${cy - r} Z`;
                }

                shadowPath.setAttribute("d", path);
            }

            // Mise Ã  jour de la date simulÃ©e
            function updateSimulatedDate(phase) {
                const now = new Date();
                const lunarCycle = 29.530588853;
                const currentPhase = SunCalc.getMoonIllumination(now).phase;
                
                // Calculer la diffÃ©rence en jours
                let dayDifference;
                if (phase >= currentPhase) {
                    dayDifference = (phase - currentPhase) * lunarCycle;
                } else {
                    dayDifference = (1 - currentPhase + phase) * lunarCycle;
                }
                
                // CrÃ©er une nouvelle date avec le dÃ©calage
                const simulatedDate = new Date(now);
                simulatedDate.setDate(now.getDate() + Math.round(dayDifference));
                
                // Formater la date
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateLabel.textContent = simulatedDate.toLocaleDateString('fr-FR', options);
            }

            function updateFromSlider() {
                const value = parseFloat(slider.value);
                updatePhasePath(value);
                label.textContent = `Phase : ${getPhaseName(value)}`;
                updateSimulatedDate(value);
            }

            function loadSunCalc(callback) {
                if (window.SunCalc) callback();
                else {
                    const script = document.createElement("script");
                    script.src = "https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js";
                    script.onload = callback;
                    document.head.appendChild(script);
                }
            }

            function resetToCurrentPhase() {
                const now = new Date();
                const { phase } = SunCalc.getMoonIllumination(now);
                slider.value = phase.toFixed(2);
                updatePhasePath(phase);
                label.textContent = `Phase : ${getPhaseName(phase)}`;
                updateSimulatedDate(phase);
            }

            loadSunCalc(() => {
                resetToCurrentPhase();
                slider.addEventListener("input", updateFromSlider);
                resetBtn.addEventListener("click", resetToCurrentPhase);
            });
        })();
    </script>
</body>
</html>
